---
title: "Summary: Reintroductions of exposed/unexposed frogs and associated outcomes"
author: "Roland A. Knapp"
format: 
  html:
    toc: true
df-print: kable
---

## Setup

```{r}
#| eval: true
#| output: false
#| code-fold: true
#| code-summary: "Setup code"

# Install packages from remote - if necessary
remotes::install_github("SNARL1/pgutils")

# Load installed packages
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}
librarian::shelf(here, readr, dplyr, tidyr, stringr, magrittr, lubridate)
```

## Retrieve data subsets from PostgreSQL database

- Before running the following code chunk, connect to database server via SSH or VPN. 
- Tables are saved as CSV files to allow rendering of QMD. Rendering fails during interactive process to connect to database. Therefore, database connection chunk is set to "eval: false" and saved CSV are read in during rendering. 


```{r}
#| eval: false
#| output: false
#| code-fold: true
#| code-summary: "Reintroduction information"

# Reintroduction data
con <- pgutils::connect_to_pg()

relocate <- tbl(con, "relocate") %>%
  rename(
    relocate_comment = comment,
    relocate_id = id
  )

relocate_frog <- tbl(con, "relocate_frog") %>%
  rename(
    relocate_frog_comment = comment,
    relocate_frog_id = id
  )

reintroduction <- relocate %>%
  inner_join(relocate_frog, by = "relocate_id") %>%
    select(
    zoo, 
    collect_date, 
    release_siteid1,
    release_date,
    type,
    pit_tag_ref,
    tag_new,
    length,
    weight,
    swab_id,
    bd_exposure,
    relocate_comment,
    relocate_frog_comment
  ) %>%
  collect()

# Create species column
site <- tbl(con, "site") %>%
  rename(site_id = id) %>% 
  select(site_id,
         drainage
  ) %>% 
  collect()

reintroduction <- reintroduction %>% 
  left_join(site, join_by(release_siteid1 == site_id)) %>% 
  mutate(
    species = if_else(
      str_detect(drainage, "kings_sf|kern"),
      "ramu",
      "rasi"
    ) 
  ) %>% 
  select(-drainage)

reintroduction %>% write_csv(here("data", "reintroduction.csv"))

connections::connection_close(con) 

rm(con, relocate, relocate_frog, site)
```

## Bd exposure history table

```{r}
#| eval: true
#| output: true
#| code-fold: true
#| code-summary: "Bd exposure history for reintroduced cohorts"

reintroduction <- read_csv(here("data", "reintroduction.csv"))

exposed_unexposed <- reintroduction %>%
filter(!(bd_exposure == "")) %>% 
group_by(release_siteid1, species, zoo, release_date, bd_exposure) %>%
  summarise(n_frogs = n(), .groups = "drop") %>%
pivot_wider(
    names_from = bd_exposure,
    values_from = n_frogs,
    values_fill = 0
  ) %>%
# Keep only rows with at least one exposed AND one unexposed (12 reintroduced cohorts only included unexposed)
filter(exposed > 0, unexposed > 0) %>% 
mutate(zoo = replace_na(zoo, "ucsb")) %>% 
arrange(release_siteid1, release_date)

# knitr::kable(exposed_unexposed)
```

## To-do list: 

-   Check on 2024 exposed-unexposed data. Not in database?

-   Identify issues with all exposed-unexposed reintroductions by site-date.

    -   \- Roland takes \< 2019, Tom takes \>= 2019

-   Zoo swabs from pre-reintroduction frogs.

-   Sources of information: zoo personnel, Cherie's lab, MLRG qPCR Google Doc, Vredenburg lab, MLRG qPCR database

### Site assignments: 

-   Milestone Basin: 21078/21081 to 20196/20198/20199 Reintroductions (RK)

-   Sixty Lake Basin: 10418/10421/11069 to 10421 Reintroductions (RK)

-   Upper Basin: 10475/10476/10477 to 10277/10285/10315 Reintroduction (RK)

-   Desolation: 84221 to 84313 Reintroductions (RK)

-   Desolation: 84221 to 84235 Reintroductions (RK)

-   Rocky Basin: 50783 to 50785 Reintroduction (TS)

-   Laurel Basin: 50783 to 20276 Reintroductions (TS)

-   Upper LeConte Basin: 10055/10206 to 10101/10102/11858 Reintroductions (TS)

-   Goddard Basin: 10037/10055 to 10109/10114 Reintroductions (TS)

-   Humphreys Basin: 54188 to 50183 Reintroductions (TS)

## Information for table

-   Release site ID and basin name
-   R. muscosa or R. sierrae
-   Zoo
-   Source population type (Bd-naive, persisting, recovering)
-   Bd load at end of zoo Bd exposure for exposed and unexposed frogs (median, range).
-   Bd isolates
-   Any Bd positives in unexposed group?
-   Release date
-   Sample sizes of exposed and unexposed groups
-   Number of frogs recaptured during first 2 years
-   Bd load during first 2 years post-release for exposed and unexposed frogs (median, range)
-   Reintroduction outcome: epizootic/extirpation, enzootic/extirpation, enzootic/establishment
-   Other frog treatments that may have occurred at zoo (e.g. brumation)

## Create table describing each reintroduced cohort

```{r}

```
