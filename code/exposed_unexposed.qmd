---
title: "Summary: Reintroductions of exposed/unexposed frogs and associated outcomes"
author: "Roland A. Knapp"
format: html:
  toc: true
---

## Load packages

```{r}
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}
librarian::shelf(DBI, config, here, readr, connections, dplyr, tidyr, stringr, magrittr, lubridate)
```

## Connect to database

-   Before running this code chunk, establish connection to database server (via VPN or SSH)

```{r}
# Select configuration of database of interest (connection paramaters for all databases provided in config.yml - in working directory)
Sys.setenv(R_CONFIG_ACTIVE = "amphibians-eri")

# Using connection_open from connections package shows structure of database tables in Connections pane
con <- connection_open(RPostgres::Postgres(),
                       dbname = config::get("dbname"),
                       host = config::get("host"),
                       port = config::get("port"),
                       user = config::get("user"),
                       password = rstudioapi::askForPassword("password")) # Enter password from password manager ("ERI GRIT Postgres")

# Set search path to schema of interest
dbExecute(con, "SET search_path TO public")
```

## Retrieve data subsets from PostgreSQL database

### Reintroduction data

```{r}
relocate <- tbl(con, "relocate") %>%
  rename(
    relocate_comment = comment,
    relocate_id = id
  )

relocate_frog <- tbl(con, "relocate_frog") %>%
  rename(
    relocate_frog_comment = comment,
    relocate_frog_id = id
  )

reintroduction <- relocate %>%
  inner_join(relocate_frog, by = "relocate_id") %>%
    select(
    release_siteid1,
    release_date,
    type,
    pit_tag_ref,
    tag_new,
    length,
    weight,
    swab_id,
    bd_exposure,
    relocate_comment,
    relocate_frog_comment
  ) %>%
  collect()
```

## Disconnect from database

```{r db_disconnect}
connection_close(con) 
rm(con)
```

## Bd exposure history

```{r}
exposed_unexposed <- reintroduction %>%
filter(!(bd_exposure == "")) %>% 
group_by(release_siteid1, release_date, bd_exposure) %>%
  summarise(n_frogs = n(), .groups = "drop") %>%
  pivot_wider(
    names_from = bd_exposure,
    values_from = n_frogs,
    values_fill = 0
  ) %>%
  # Keep only rows with at least one exposed AND one unexposed
  filter(exposed > 0, unexposed > 0)
```

-   Check on 2024 exposed-unexposed data. Not in database.
-   Issues with all exposed-reintroductions by site-date.
    -   Roland takes \< 2019, Tom takes \>= 2019
-   Zoo swabs from pre-reintroduction frogs.
-   Sources of information: zoo personnel, Cherie's lab, MLRG qPCR Google Doc, Vredenburg lab, MLRG qPCR database
